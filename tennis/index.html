<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tennis Live | Ryan Espejo</title>
  <style>
    :root {
      --bg: #07090f;
      --panel: #111625;
      --panel-soft: #171d2f;
      --line: #252d45;
      --text: #f4f7ff;
      --muted: #9ba7c6;
      --accent: #62f2a6;
      --accent-soft: rgba(98, 242, 166, 0.14);
      --danger: #ff6a7b;
      --gold: #ffcf6b;
      --gold-soft: rgba(255, 207, 107, 0.14);
      --atp: #7dd3fc;
      --wta: #f9a8d4;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background:
        radial-gradient(circle at top right, #1c2b5f 0%, transparent 40%),
        radial-gradient(circle at bottom left, #193838 0%, transparent 35%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem 1.25rem 3rem;
    }

    .app { max-width: 1160px; margin: 0 auto; display: grid; gap: 1.1rem; }

    /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
    .topbar { display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .brand h1 { font-size: clamp(1.35rem, 3vw, 2rem); letter-spacing: 0.01em; }
    .brand p { color: var(--muted); font-size: 0.9rem; margin-top: 0.25rem; }
    .home-link {
      text-decoration: none; color: var(--text); border: 1px solid var(--line);
      background: var(--panel); padding: 0.55rem 0.95rem; border-radius: 999px;
      font-size: 0.85rem; transition: 0.2s ease;
    }
    .home-link:hover { border-color: var(--accent); color: var(--accent); }

    /* ‚îÄ‚îÄ Source pill ‚îÄ‚îÄ */
    .source-pill {
      font-size: 0.72rem; padding: 0.2rem 0.6rem; border-radius: 999px;
      letter-spacing: 0.04em; text-transform: uppercase; border: 1px solid transparent;
      display: inline-flex; align-items: center; gap: 0.35rem;
    }
    .source-pill.python { color: var(--atp); border-color: rgba(125,211,252,0.35); background: rgba(125,211,252,0.1); }
    .source-pill.direct { color: var(--gold); border-color: rgba(255,207,107,0.35); background: var(--gold-soft); }
    .source-pill.fallback { color: var(--danger); border-color: rgba(255,106,123,0.35); background: rgba(255,106,123,0.1); }

    /* ‚îÄ‚îÄ Filters ‚îÄ‚îÄ */
    .filter-bar { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
    .date-row { display: flex; gap: 0.45rem; align-items: center; overflow-x: auto; padding-bottom: 2px; scrollbar-width: none; }
    .date-row::-webkit-scrollbar { display: none; }

    .chip {
      border: 1px solid var(--line); background: var(--panel); color: var(--muted);
      border-radius: 999px; padding: 0.38rem 0.8rem; font-size: 0.78rem;
      letter-spacing: 0.03em; text-transform: uppercase; cursor: pointer;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
      white-space: nowrap; flex-shrink: 0; font-family: inherit;
    }
    .chip:hover { border-color: var(--accent); color: var(--accent); }
    .chip.active { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
    .chip.chip-live { display: inline-flex; align-items: center; gap: 0.35rem; }
    .chip.chip-live.active { border-color: var(--danger); color: var(--danger); background: rgba(255,106,123,0.1); }
    .live-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
    .chip.chip-live.active .live-dot { animation: blink 1.2s ease-in-out infinite; }
    @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* ‚îÄ‚îÄ Tournament dropdown ‚îÄ‚îÄ */
    .tourn-select {
      background: var(--panel);
      color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 0.38rem 1.9rem 0.38rem 0.8rem;
      font-size: 0.78rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-family: inherit;
      cursor: pointer;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%239ba7c6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.65rem center;
      background-size: 8px 5px;
      transition: border-color 0.15s, color 0.15s;
      max-width: 200px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .tourn-select:hover { border-color: var(--accent); color: var(--accent); }
    .tourn-select:focus { border-color: var(--accent); outline: none; }
    .tourn-select option { background: #111625; color: #f4f7ff; text-transform: none; letter-spacing: 0; }

    /* ‚îÄ‚îÄ Countdown ‚îÄ‚îÄ */
    .countdown {
      margin-left: auto; display: flex; align-items: center; gap: 0.45rem;
      color: var(--muted); font-size: 0.8rem;
    }
    .countdown-ring { width: 22px; height: 22px; }
    .countdown-ring circle {
      fill: none; stroke: var(--line); stroke-width: 3;
      transform-origin: 50% 50%; transform: rotate(-90deg);
    }
    .countdown-ring circle.progress {
      stroke: var(--accent); stroke-linecap: round;
      transition: stroke-dashoffset 0.9s linear;
    }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .layout { display: grid; grid-template-columns: 1fr 340px; gap: 1rem; align-items: start; }

    /* ‚îÄ‚îÄ Matches panel ‚îÄ‚îÄ */
    .matches-panel {
      background: linear-gradient(180deg, var(--panel-soft), var(--panel));
      border: 1px solid var(--line); border-radius: 16px; overflow: hidden;
    }
    .panel-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.85rem 1rem; border-bottom: 1px solid var(--line);
    }
    .panel-header h2 { font-size: 0.88rem; letter-spacing: 0.03em; text-transform: uppercase; color: var(--muted); }
    .live-count { font-size: 0.76rem; padding: 0.18rem 0.55rem; border-radius: 999px; letter-spacing: 0.04em; }

    /* scrollable match list */
    .matches-scroll { max-height: calc(100vh - 11rem); overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--line) transparent; }
    .matches-scroll::-webkit-scrollbar { width: 4px; }
    .matches-scroll::-webkit-scrollbar-track { background: transparent; }
    .matches-scroll::-webkit-scrollbar-thumb { background: var(--line); border-radius: 99px; }

    /* ‚îÄ‚îÄ Tournament sections ‚îÄ‚îÄ */
    .tournament-section { border-bottom: 1px solid var(--line); }
    .tournament-section:last-child { border-bottom: 0; }
    .tournament-header {
      display: flex; align-items: center; gap: 0.55rem; flex-wrap: wrap;
      padding: 0.55rem 1rem;
      background: rgba(10, 14, 26, 0.7);
      border-bottom: 1px solid var(--line);
      font-size: 0.75rem; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase;
      color: var(--muted);
      position: sticky; top: 0; z-index: 2;
      backdrop-filter: blur(10px);
    }
    .tour-label {
      font-size: 0.63rem; padding: 0.1rem 0.42rem; border-radius: 999px; font-weight: 700; letter-spacing: 0.06em; flex-shrink: 0;
    }
    .tour-label.atp { color: var(--atp); background: rgba(125,211,252,0.1); border: 1px solid rgba(125,211,252,0.3); }
    .tour-label.wta { color: var(--wta); background: rgba(249,168,212,0.1); border: 1px solid rgba(249,168,212,0.3); }
    .tourn-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .tourn-live-pill {
      display: inline-flex; align-items: center; gap: 0.3rem;
      font-size: 0.65rem; color: var(--accent); flex-shrink: 0;
    }
    .tourn-live-pill .dot {
      width: 6px; height: 6px; border-radius: 50%; background: var(--accent);
      animation: pulse 2s ease-in-out infinite; flex-shrink: 0;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 3px rgba(98,242,166,0.2); }
      50% { box-shadow: 0 0 0 6px rgba(98,242,166,0.04); }
    }

    /* ‚îÄ‚îÄ Match cards ‚îÄ‚îÄ */
    .match {
      padding: 0.75rem 1rem; border-bottom: 1px solid var(--line); transition: background 0.15s;
      cursor: pointer; position: relative;
    }
    .match:last-child { border-bottom: 0; }
    .match:hover { background: rgba(255,255,255,0.025); }
    .match.selected { background: rgba(98,242,166,0.06); }
    .match.selected::before {
      content: ''; position: absolute; left: 0; top: 0; bottom: 0;
      width: 3px; background: var(--accent); border-radius: 0 2px 2px 0;
    }

    .match-meta {
      display: flex; justify-content: space-between; align-items: center;
      color: var(--muted); font-size: 0.73rem; text-transform: uppercase;
      letter-spacing: 0.04em; margin-bottom: 0.55rem; gap: 0.4rem;
    }
    .match-round { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .match-status-text { white-space: nowrap; font-size: 0.71rem; }

    .badge {
      font-size: 0.66rem; padding: 0.16rem 0.45rem; border-radius: 999px;
      letter-spacing: 0.06em; text-transform: uppercase; white-space: nowrap; flex-shrink: 0;
    }
    .badge-live { color: var(--accent); background: var(--accent-soft); border: 1px solid rgba(98,242,166,0.4); }
    .badge-final { color: var(--muted); background: rgba(155,167,198,0.08); border: 1px solid rgba(155,167,198,0.25); }
    .badge-scheduled { color: var(--gold); background: var(--gold-soft); border: 1px solid rgba(255,207,107,0.35); }

    /* Player rows */
    .players { display: grid; gap: 0.38rem; }
    .row {
      display: grid;
      grid-template-columns: 1.4rem 1fr repeat(var(--sets, 2), 1.75rem) 2.3rem;
      gap: 0.38rem; align-items: center; font-size: 0.91rem;
    }
    .serve-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); justify-self: center; }
    .serve-dot.hidden { visibility: hidden; }
    .pname { font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .pname.winner { color: var(--accent); }
    .set-score {
      min-width: 1.75rem; text-align: center; border-radius: 5px;
      border: 1px solid var(--line); padding: 0.12rem 0.15rem;
      color: #dce4ff; font-variant-numeric: tabular-nums; font-size: 0.86rem;
    }
    .set-score.won { border-color: rgba(98,242,166,0.45); background: rgba(98,242,166,0.08); color: var(--accent); }
    .game-score {
      min-width: 2.3rem; text-align: center; border-radius: 5px;
      border: 1px solid rgba(98,242,166,0.35); background: rgba(98,242,166,0.07);
      color: var(--accent); font-variant-numeric: tabular-nums; font-size: 0.86rem;
      padding: 0.12rem 0.15rem;
    }

    .status-msg { color: var(--muted); font-size: 0.85rem; padding: 1.2rem 1rem; }
    .updated-at { color: var(--muted); font-size: 0.73rem; padding: 0.55rem 1rem; border-top: 1px solid var(--line); }

    /* ‚îÄ‚îÄ Insights panel ‚îÄ‚îÄ */
    .insights-panel {
      background: linear-gradient(180deg, var(--panel-soft), var(--panel));
      border: 1px solid var(--line); border-radius: 16px; overflow: hidden;
      position: sticky; top: 1rem;
    }
    .insights-empty {
      padding: 3rem 1.4rem; text-align: center; color: var(--muted);
      display: flex; flex-direction: column; align-items: center; gap: 0.75rem;
    }
    .insights-empty .ei-icon { font-size: 2.2rem; }
    .insights-empty p { font-size: 0.83rem; line-height: 1.6; }

    .ins-match-header {
      padding: 1rem; border-bottom: 1px solid var(--line);
    }
    .ins-players {
      display: flex; justify-content: space-between; align-items: center;
      font-weight: 600; font-size: 0.97rem; gap: 0.5rem; margin-bottom: 0.35rem;
    }
    .ins-p { flex: 1; }
    .ins-p.right { text-align: right; }
    .ins-vs { color: var(--muted); font-size: 0.8rem; font-weight: 400; flex-shrink: 0; }
    .ins-sub { font-size: 0.73rem; color: var(--muted); }
    .ins-status-badge { margin-top: 0.4rem; }

    .ins-section { border-top: 1px solid var(--line); padding: 0.85rem 1rem; }
    .ins-title {
      font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.07em;
      color: var(--muted); margin-bottom: 0.65rem; font-weight: 600;
    }

    /* H2H */
    .h2h-labels { display: flex; justify-content: space-between; font-size: 0.78rem; font-weight: 600; margin-bottom: 0.35rem; }
    .h2h-bar {
      display: flex; height: 7px; border-radius: 999px; overflow: hidden;
      background: var(--line); gap: 2px; margin-bottom: 0.35rem;
    }
    .h2h-seg { border-radius: 999px; transition: flex 0.5s ease; }
    .h2h-seg.p1 { background: var(--accent); }
    .h2h-seg.p2 { background: var(--wta); }
    .h2h-note { font-size: 0.71rem; color: var(--muted); }

    /* Recent form */
    .form-line { display: flex; align-items: center; gap: 0.55rem; margin-bottom: 0.5rem; }
    .form-line:last-child { margin-bottom: 0; }
    .form-pname { font-size: 0.78rem; font-weight: 500; min-width: 5.5rem; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .form-badges { display: flex; gap: 0.28rem; flex-wrap: wrap; }
    .fb {
      width: 1.45rem; height: 1.45rem; border-radius: 4px;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: 700; flex-shrink: 0;
    }
    .fb.W { background: rgba(98,242,166,0.13); color: var(--accent); border: 1px solid rgba(98,242,166,0.32); }
    .fb.L { background: rgba(255,106,123,0.1); color: var(--danger); border: 1px solid rgba(255,106,123,0.28); }
    .form-empty { font-size: 0.76rem; color: var(--muted); }

    /* Rankings */
    .rank-row { display: flex; justify-content: space-between; align-items: baseline; padding: 0.2rem 0; }
    .rank-pname { font-size: 0.84rem; font-weight: 500; }
    .rank-num { font-size: 1.05rem; font-weight: 700; color: var(--gold); }
    .rank-msg { font-size: 0.76rem; color: var(--muted); font-style: italic; }

    /* ‚îÄ‚îÄ Prediction sources ‚îÄ‚îÄ */
    .insights-scroll { overflow-y: auto; max-height: calc(100vh - 5rem); scrollbar-width: thin; scrollbar-color: var(--line) transparent; }
    .insights-scroll::-webkit-scrollbar { width: 4px; }
    .insights-scroll::-webkit-scrollbar-thumb { background: var(--line); border-radius: 99px; }

    .pred-links { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 0.6rem; }
    .pred-link {
      font-size: 0.72rem; padding: 0.28rem 0.65rem; border-radius: 999px;
      text-decoration: none; border: 1px solid; transition: opacity 0.15s, transform 0.1s;
      display: inline-flex; align-items: center; gap: 0.3rem; white-space: nowrap;
    }
    .pred-link:hover { opacity: 0.75; transform: translateY(-1px); }

    .pred-article { padding: 0.45rem 0; border-bottom: 1px solid var(--line); }
    .pred-article:last-child { border-bottom: none; }
    .pred-article-title { font-size: 0.79rem; color: var(--text); text-decoration: none; line-height: 1.45; display: block; }
    .pred-article-title:hover { color: var(--accent); }
    .pred-snippet {
      font-size: 0.74rem; color: var(--muted); line-height: 1.55;
      margin-top: 0.3rem; display: -webkit-box; -webkit-line-clamp: 4;
      -webkit-box-orient: vertical; overflow: hidden;
    }
    .pred-source-label { font-size: 0.64rem; color: var(--muted); margin-top: 0.18rem; letter-spacing: 0.02em; }
    .pred-msg { font-size: 0.75rem; color: var(--muted); font-style: italic; }

    @media (max-width: 920px) {
      .layout { grid-template-columns: 1fr; }
      .insights-panel { position: static; }
      .matches-scroll { max-height: none; }
      .insights-scroll { max-height: none; }
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="topbar">
      <div class="brand">
        <h1>Tennis Live Center</h1>
        <p id="subtitle">Connecting to live feed‚Ä¶</p>
      </div>
      <a class="home-link" href="/">&larr; Back home</a>
    </section>

    <section class="filter-bar" aria-label="filters">
      <button class="chip active" data-tour="all">All</button>
      <button class="chip" data-tour="atp">ATP</button>
      <button class="chip" data-tour="wta">WTA</button>
      <button class="chip chip-live" id="btn-live"><span class="live-dot"></span>Live</button>
      <select id="tourn-select" class="tourn-select">
        <option value="">All Tournaments</option>
      </select>
      <div class="countdown" id="countdown-wrap" style="display:none">
        <svg class="countdown-ring" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="9"/>
          <circle class="progress" id="countdown-ring" cx="12" cy="12" r="9"
            stroke-dasharray="56.5" stroke-dashoffset="0"/>
        </svg>
        <span id="countdown-label">30s</span>
        <span id="source-pill"></span>
      </div>
    </section>

    <div class="date-row" id="date-row"></div>

    <section class="layout">
      <article class="matches-panel">
        <header class="panel-header">
          <h2>Matches</h2>
          <span class="live-count badge badge-live" id="live-count">‚Äî</span>
        </header>
        <div class="matches-scroll" id="matches-scroll">
          <div class="status-msg" id="status-msg">Fetching scoreboard‚Ä¶</div>
          <div id="matches"></div>
          <div class="updated-at" id="updated-at" style="display:none"></div>
        </div>
      </article>

      <aside class="insights-panel" id="insights-panel">
        <header class="panel-header">
          <h2>Match Insights</h2>
        </header>
        <div class="insights-scroll">
          <div id="insights-body">
            <div class="insights-empty">
              <div class="ei-icon">üìä</div>
              <p>Click any match to see H2H record, recent form, live rankings, and prediction sources.</p>
            </div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <script>
    const MATCHES_EL  = document.getElementById('matches');
    const STATUS_MSG  = document.getElementById('status-msg');
    const UPDATED_AT  = document.getElementById('updated-at');
    const LIVE_COUNT  = document.getElementById('live-count');
    const SUBTITLE    = document.getElementById('subtitle');
    const SOURCE_PILL = document.getElementById('source-pill');
    const CDW         = document.getElementById('countdown-wrap');
    const CDL         = document.getElementById('countdown-label');
    const CDR         = document.getElementById('countdown-ring');
    const DATE_ROW    = document.getElementById('date-row');
    const INSIGHTS    = document.getElementById('insights-body');
    const BTN_LIVE    = document.getElementById('btn-live');
    const TOURN_SEL   = document.getElementById('tourn-select');

    const tourChips = [...document.querySelectorAll('.chip[data-tour]')];

    const ESPN = {
      atp: 'https://site.api.espn.com/apis/site/v2/sports/tennis/atp/scoreboard',
      wta: 'https://site.api.espn.com/apis/site/v2/sports/tennis/wta/scoreboard',
    };

    const today = () => new Date().toISOString().slice(0, 10);
    const FALLBACK = [
      { id:'s1', tour:'atp', tournamentName:'Sample', round:'Final', tournament:'ATP ¬∑ Sample', status:'Set 3 ¬∑ 5-4', isLive:true, isComplete:false, date:today(), playerIds:['1','2'],
        players:[{name:'C. Alcaraz',sets:['6','3','5'],game:'40',serving:true,winner:false},{name:'L. Musetti',sets:['4','6','4'],game:'30',serving:false,winner:false}] },
      { id:'s2', tour:'wta', tournamentName:'Sample', round:'Final', tournament:'WTA ¬∑ Sample', status:'Set 2 ¬∑ 2-1', isLive:true, isComplete:false, date:today(), playerIds:['3','4'],
        players:[{name:'I. Swiatek',sets:['6','2'],game:'Ad',serving:true,winner:false},{name:'D. Kasatkina',sets:['1','1'],game:'40',serving:false,winner:false}] },
    ];

    const REFRESH_SEC  = 30;
    const CIRCUMFERENCE = 56.5;
    let cachedMatches    = [];
    let tourFilter       = 'all';
    let liveOnly         = false;
    let dateFilter       = null;
    let tournamentFilter = '';
    let selectedId       = null;
    let countdown     = REFRESH_SEC;
    let countdownTimer = null;

    // ‚îÄ‚îÄ Fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async function fetchFromPython() {
      const res = await fetch('/api/tennis', { signal: AbortSignal.timeout(8000) });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (!Array.isArray(data.matches)) throw new Error('Bad payload');
      return { matches: data.matches, source: 'python' };
    }

    function normalizeESPN(comp, tour, eventName) {
      const competitors = comp.competitors || [];
      if (competitors.length < 2) return null;
      const st = comp.status?.type || {};
      const status = st.shortDetail || st.description || 'Scheduled';
      const state = st.state || '';
      const roundName = comp.round?.displayName || '';
      let tournament = `${tour.toUpperCase()} ¬∑ ${eventName}`;
      if (roundName) tournament += ` ¬∑ ${roundName}`;
      const sorted = [...competitors].sort((a, b) => (a.order ?? 99) - (b.order ?? 99));
      const players = sorted.map(c => ({
        name:     c.athlete?.shortName || c.athlete?.displayName || c.roster?.shortDisplayName || c.roster?.displayName || c.name || 'Player',
        fullName: c.athlete?.displayName || c.athlete?.shortName || c.roster?.displayName || c.roster?.shortDisplayName || c.name || 'Player',
        sets: (c.linescores || []).map(l => l.value != null ? String(Math.round(l.value)) : '‚Äî'),
        game: String(c.score || '‚Äî'),
        serving: !!c.status?.isCurrent,
        winner: !!c.winner,
      }));
      const playerIds = sorted.map(c => String(c.id || ''));
      const date = (comp.startDate || comp.date || '').slice(0, 10);
      return { id: String(comp.id || ''), tour, tournamentName: eventName, round: roundName,
               tournament, date, playerIds, status,
               isLive: state === 'in', isComplete: state === 'post', players };
    }

    async function fetchDirectESPN() {
      const [a, w] = await Promise.all([
        fetch(ESPN.atp).then(r => r.json()),
        fetch(ESPN.wta).then(r => r.json()),
      ]);
      const matches = [];
      for (const [data, tour] of [[a, 'atp'], [w, 'wta']]) {
        for (const event of data.events || []) {
          const eventName = event.shortName || event.name || 'Tournament';
          for (const grouping of event.groupings || []) {
            for (const comp of grouping.competitions || []) {
              const m = normalizeESPN(comp, tour, eventName);
              if (m) matches.push(m);
            }
          }
        }
      }
      return { matches, source: 'direct' };
    }

    async function loadMatches() {
      try { return await fetchFromPython(); }
      catch (_) {
        try { return await fetchDirectESPN(); }
        catch (__) { return { matches: FALLBACK, source: 'fallback' }; }
      }
    }

    // ‚îÄ‚îÄ Date chips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Local-timezone date string (avoids UTC rollover making "today" wrong in US evenings)
    function localDateStr(dayOffset = 0) {
      const d = new Date();
      d.setDate(d.getDate() + dayOffset);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function fmtDate(d) {
      if (d === localDateStr(0))  return 'Today';
      if (d === localDateStr(-1)) return 'Yesterday';
      if (d === localDateStr(1))  return 'Tomorrow';
      return new Date(d + 'T12:00:00Z').toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
    }

    function updateDateChips(matches) {
      const dates = [...new Set(matches.map(m => m.date).filter(Boolean))].sort(); // past left ‚Üí future right
      const allActive = dateFilter === null;
      DATE_ROW.innerHTML =
        `<button class="chip date-chip${allActive ? ' active' : ''}" data-date="">All</button>` +
        dates.map(d =>
          `<button class="chip date-chip${dateFilter === d ? ' active' : ''}" data-date="${d}">${fmtDate(d)}</button>`
        ).join('');
      DATE_ROW.querySelectorAll('.date-chip').forEach(btn =>
        btn.addEventListener('click', () => {
          dateFilter = btn.dataset.date || null; // empty string ‚Üí null (show all)
          updateDateChips(cachedMatches);
          renderAll(cachedMatches);
        })
      );
    }

    // ‚îÄ‚îÄ Tournament dropdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function updateTournSelect(matches) {
      const scoped = tourFilter === 'all' ? matches : matches.filter(m => m.tour === tourFilter);
      const tournaments = [...new Set(scoped.map(m => m.tournamentName).filter(Boolean))].sort();
      const prev = TOURN_SEL.value;
      TOURN_SEL.innerHTML = '<option value="">All Tournaments</option>' +
        tournaments.map(t => `<option value="${t}"${prev === t ? ' selected' : ''}>${t}</option>`).join('');
      // If the previously selected tournament no longer exists in this scope, reset
      if (prev && !tournaments.includes(prev)) {
        tournamentFilter = '';
      }
    }

    // ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function badgeHtml(m) {
      if (m.isLive)     return '<span class="badge badge-live">Live</span>';
      if (m.isComplete) return '<span class="badge badge-final">Final</span>';
      return '<span class="badge badge-scheduled">Upcoming</span>';
    }

    function renderMatch(m) {
      const maxSets = Math.max(...m.players.map(p => p.sets.length), 2);
      const rows = m.players.map(p => {
        const opp = m.players.find(x => x !== p);
        const setScores = Array.from({ length: maxSets }, (_, i) => {
          const val = p.sets[i] ?? '‚Äî';
          const mine = parseInt(val, 10);
          const theirs = parseInt(opp?.sets[i] ?? '0', 10);
          const won = !isNaN(mine) && !isNaN(theirs) && mine > theirs;
          return `<span class="set-score${won ? ' won' : ''}">${val}</span>`;
        }).join('');
        return `<div class="row" style="--sets:${maxSets}">
          <span class="serve-dot${p.serving ? '' : ' hidden'}"></span>
          <span class="pname${p.winner ? ' winner' : ''}">${p.name}</span>
          ${setScores}
          <span class="game-score">${m.isComplete ? '' : p.game}</span>
        </div>`;
      }).join('');

      const statusText = m.isLive ? `<span class="match-status-text">${m.status}</span>` : '';
      return `
        <div class="match${m.id === selectedId ? ' selected' : ''}" data-id="${m.id}">
          <div class="match-meta">
            <span class="match-round">${m.round || '‚Äî'}</span>
            ${statusText}
            ${badgeHtml(m)}
          </div>
          <div class="players">${rows}</div>
        </div>`;
    }

    function renderAll(matches) {
      let filtered = matches;
      if (tourFilter !== 'all')  filtered = filtered.filter(m => m.tour === tourFilter);
      if (liveOnly)              filtered = filtered.filter(m => m.isLive);
      if (dateFilter)            filtered = filtered.filter(m => m.date === dateFilter);
      if (tournamentFilter)      filtered = filtered.filter(m => m.tournamentName === tournamentFilter);

      const liveN = matches.filter(m => m.isLive).length;
      LIVE_COUNT.textContent = liveN ? `${liveN} Live` : `${matches.length} total`;
      BTN_LIVE.innerHTML = `<span class="live-dot"></span>Live${liveN ? ` (${liveN})` : ''}`;

      if (!filtered.length) {
        MATCHES_EL.innerHTML = '<div class="status-msg">No matches for this filter.</div>';
        return;
      }

      // Group by (tour, tournamentName)
      const groups = new Map();
      for (const m of filtered) {
        const key = `${m.tour}|${m.tournamentName}`;
        if (!groups.has(key)) groups.set(key, { tour: m.tour, name: m.tournamentName || '', matches: [] });
        groups.get(key).matches.push(m);
      }

      // Sort: live-containing groups first, then ATP before WTA
      const sorted = [...groups.values()].sort((a, b) => {
        const aL = a.matches.some(m => m.isLive) ? 1 : 0;
        const bL = b.matches.some(m => m.isLive) ? 1 : 0;
        if (bL !== aL) return bL - aL;
        return a.tour.localeCompare(b.tour);
      });

      MATCHES_EL.innerHTML = sorted.map(g => {
        const liveCount = g.matches.filter(m => m.isLive).length;
        const livePill  = liveCount
          ? `<span class="tourn-live-pill"><span class="dot"></span>${liveCount} live</span>`
          : '';
        return `
          <div class="tournament-section">
            <div class="tournament-header">
              <span class="tour-label ${g.tour}">${g.tour.toUpperCase()}</span>
              <span class="tourn-name">${g.name}</span>
              ${livePill}
            </div>
            ${g.matches.map(renderMatch).join('')}
          </div>`;
      }).join('');

      // Click handlers on match cards
      MATCHES_EL.querySelectorAll('.match').forEach(card => {
        card.addEventListener('click', () => {
          const id = card.dataset.id;
          if (selectedId === id) {
            selectedId = null;
            card.classList.remove('selected');
            INSIGHTS.innerHTML = `<div class="insights-empty"><div class="ei-icon">üìä</div><p>Click any match to see H2H record, recent form, and live rankings.</p></div>`;
          } else {
            MATCHES_EL.querySelectorAll('.match.selected').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedId = id;
            const m = cachedMatches.find(x => x.id === id);
            if (m) showInsights(m);
          }
        });
      });
    }

    // ‚îÄ‚îÄ Predictions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    const PRED_SOURCES = [
      { id: 'tennistonic', name: 'Tennis Tonic H2H',    color: '#62f2a6' },
      { id: 'grandstand',  name: 'The Grandstand',      color: '#7dd3fc', url: 'https://tenngrand.com/category/match-previews/' },
      { id: 'lwos',        name: 'Last Word on Sports',  color: '#f9a8d4', url: 'https://lastwordonsports.com/tennis/' },
    ];

    function predLinks(name1, name2, fullName1, fullName2, tournament, year) {
      const tournQ = encodeURIComponent(`${tournament} ${year} tennis`);
      const xQ     = encodeURIComponent(`${name1} ${name2} ${tournament} ${year}`);
      // Tennis Tonic H2H URL: full name with spaces ‚Üí dashes
      const ttSlug = (n) => (n || '').replace(/\s+/g, '-');
      const ttH2h  = `https://tennistonic.com/head-to-head-compare/${ttSlug(fullName1)}-Vs-${ttSlug(fullName2)}/`;
      const siteLinks = PRED_SOURCES.map(s => {
        const href = s.id === 'tennistonic' ? ttH2h : s.url.replace('{}', tournQ);
        return `<a class="pred-link" href="${href}" target="_blank" rel="noopener"
                   style="color:${s.color};border-color:${s.color}40;background:${s.color}12">
                   ${s.name}</a>`;
      }).join('');
      const xLink = `<a class="pred-link" href="https://x.com/search?q=${xQ}&f=live" target="_blank" rel="noopener"
                       style="color:#e2e8f0;border-color:rgba(226,232,240,0.25);background:rgba(226,232,240,0.07)">
                       ùïè Search</a>`;
      return siteLinks + xLink;
    }

    async function fetchPredictions(name1, name2, fullName1, fullName2, tournament, year) {
      const el = document.getElementById('pred-articles');
      if (!el) return;
      try {
        const p1  = encodeURIComponent(name1);
        const p2  = encodeURIComponent(name2);
        const fn1 = encodeURIComponent(fullName1 || name1);
        const fn2 = encodeURIComponent(fullName2 || name2);
        const t   = encodeURIComponent(tournament || '');
        const y   = encodeURIComponent(year || '');
        const res = await fetch(
          `/api/tennis-news?player1=${p1}&player2=${p2}&fullname1=${fn1}&fullname2=${fn2}&tournament=${t}&year=${y}`,
          { signal: AbortSignal.timeout(12000) });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const articles = (data.sources || []).flatMap(s =>
          (s.articles || []).map(a => ({ ...a, sourceName: s.name, sourceColor: s.color }))
        );
        if (!el) return; // panel may have been replaced
        if (!articles.length) {
          el.innerHTML = '<span class="pred-msg">No previews found ‚Äî use the links above to browse directly.</span>';
          return;
        }
        el.innerHTML = articles.map(a => `
          <div class="pred-article">
            <a class="pred-article-title" href="${a.url}" target="_blank" rel="noopener">${a.title}</a>
            ${a.snippet ? `<p class="pred-snippet">${a.snippet}</p>` : ''}
            <div class="pred-source-label" style="color:${a.sourceColor}">${a.sourceName}</div>
          </div>`).join('');
      } catch (_) {
        if (el) el.innerHTML = '<span class="pred-msg">Could not load previews ‚Äî use links above.</span>';
      }
    }

    // ‚îÄ‚îÄ Insights ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function getH2H(matches, id1, id2) {
      if (!id1 || !id2) return { wins1: 0, wins2: 0, total: 0 };
      let wins1 = 0, wins2 = 0;
      for (const m of matches) {
        if (!m.isComplete) continue;
        const ids = m.playerIds || [];
        if (!ids.includes(id1) || !ids.includes(id2)) continue;
        const idx1 = ids.indexOf(id1);
        if (m.players[idx1]?.winner) wins1++;
        else wins2++;
      }
      return { wins1, wins2, total: wins1 + wins2 };
    }

    function getRecentForm(matches, playerId, limit = 8) {
      if (!playerId) return [];
      const results = [];
      for (const m of matches) {
        if (!m.isComplete) continue;
        const idx = (m.playerIds || []).indexOf(playerId);
        if (idx === -1) continue;
        const p = m.players[idx];
        const opp = m.players[1 - idx];
        if (!p) continue;
        results.push({ won: !!p.winner, opp: opp?.name || '?', tourn: m.tournamentName, round: m.round });
        if (results.length >= limit) break;
      }
      return results;
    }

    async function fetchRankings(tour, id1, id2) {
      const base = `https://site.api.espn.com/apis/site/v2/sports/tennis/${tour}/athletes`;
      const ext = (d) => {
        const a = d?.athlete || d || {};
        return (a.rankings?.[0]?.current) ?? a.rank ?? null;
      };
      const [r1, r2] = await Promise.all([
        fetch(`${base}/${id1}`).then(r => r.json()).then(ext).catch(() => null),
        fetch(`${base}/${id2}`).then(r => r.json()).then(ext).catch(() => null),
      ]);
      return [r1, r2];
    }

    function showInsights(match) {
      const [p1, p2] = match.players;
      const [id1, id2] = match.playerIds || ['', ''];
      const h2h   = getH2H(cachedMatches, id1, id2);
      const form1 = getRecentForm(cachedMatches, id1);
      const form2 = getRecentForm(cachedMatches, id2);

      const formBadges = (form) => {
        if (!form.length) return '<span class="form-empty">Not enough data in current feed</span>';
        return `<div class="form-badges">${form.map(r =>
          `<span class="fb ${r.won ? 'W' : 'L'}" title="${r.won ? 'Win' : 'Loss'} vs ${r.opp} ¬∑ ${r.tourn}">${r.won ? 'W' : 'L'}</span>`
        ).join('')}</div>`;
      };

      // H2H bar flex values (at least 0.5 each so bar is always visible)
      const f1 = Math.max(h2h.wins1, 0.5);
      const f2 = Math.max(h2h.wins2, 0.5);

      INSIGHTS.innerHTML = `
        <div class="ins-match-header">
          <div class="ins-players">
            <span class="ins-p">${p1.name}</span>
            <span class="ins-vs">vs</span>
            <span class="ins-p right">${p2.name}</span>
          </div>
          <div class="ins-sub">${match.tournamentName}${match.round ? ' ¬∑ ' + match.round : ''}</div>
          <div class="ins-status-badge">${badgeHtml(match)} <span style="font-size:0.78rem;color:var(--muted)">${match.status}</span></div>
        </div>

        <div class="ins-section">
          <div class="ins-title">Rankings</div>
          <div id="rank-body"><span class="rank-msg">Fetching‚Ä¶</span></div>
        </div>

        <div class="ins-section">
          <div class="ins-title">Head to Head</div>
          <div class="h2h-labels">
            <span>${h2h.wins1}</span>
            <span>${h2h.wins2}</span>
          </div>
          <div class="h2h-bar">
            <div class="h2h-seg p1" style="flex:${f1}"></div>
            <div class="h2h-seg p2" style="flex:${f2}"></div>
          </div>
          <div class="h2h-note">${h2h.total
            ? `${h2h.total} meeting${h2h.total > 1 ? 's' : ''} in current data`
            : 'No previous meetings in current data'}</div>
        </div>

        <div class="ins-section">
          <div class="ins-title">Recent Form ‚Äî ${p1.name}</div>
          <div class="form-line">${formBadges(form1)}</div>
        </div>

        <div class="ins-section">
          <div class="ins-title">Recent Form ‚Äî ${p2.name}</div>
          <div class="form-line">${formBadges(form2)}</div>
        </div>

        <div class="ins-section" id="pred-section">
          <div class="ins-title">Prediction Sources</div>
          <div class="pred-links">
            ${predLinks(p1.name, p2.name, p1.fullName || p1.name, p2.fullName || p2.name, match.tournamentName, (match.date || '').slice(0, 4))}
          </div>
          <div id="pred-articles"><span class="pred-msg">Loading previews‚Ä¶</span></div>
        </div>`;

      // Async rankings
      if (id1 && id2) {
        fetchRankings(match.tour, id1, id2).then(([r1, r2]) => {
          const el = document.getElementById('rank-body');
          if (!el) return;
          if (r1 == null && r2 == null) {
            el.innerHTML = '<span class="rank-msg">Rankings unavailable</span>';
            return;
          }
          el.innerHTML = `
            <div class="rank-row"><span class="rank-pname">${p1.name}</span><span class="rank-num">${r1 != null ? '#' + r1 : '‚Äî'}</span></div>
            <div class="rank-row"><span class="rank-pname">${p2.name}</span><span class="rank-num">${r2 != null ? '#' + r2 : '‚Äî'}</span></div>`;
        }).catch(() => {
          const el = document.getElementById('rank-body');
          if (el) el.innerHTML = '<span class="rank-msg">Rankings unavailable</span>';
        });
      } else {
        document.getElementById('rank-body').innerHTML = '<span class="rank-msg">No player ID available</span>';
      }

      // Async predictions
      fetchPredictions(p1.name, p2.name, p1.fullName || p1.name, p2.fullName || p2.name, match.tournamentName, (match.date || '').slice(0, 4));

      // On mobile scroll down to insights
      if (window.innerWidth <= 920) {
        document.getElementById('insights-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // ‚îÄ‚îÄ Refresh cycle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function setSourcePill(source) {
      const map = {
        python:   { label: 'üêç Python backend', cls: 'python' },
        direct:   { label: 'ESPN direct',        cls: 'direct' },
        fallback: { label: 'Sample data',         cls: 'fallback' },
      };
      const { label, cls } = map[source] || map.direct;
      SOURCE_PILL.className = `source-pill ${cls}`;
      SOURCE_PILL.textContent = label;
    }

    function startCountdown() {
      countdown = REFRESH_SEC;
      CDW.style.display = 'flex';
      clearInterval(countdownTimer);
      countdownTimer = setInterval(() => {
        countdown--;
        CDR.style.strokeDashoffset = CIRCUMFERENCE * (1 - countdown / REFRESH_SEC);
        CDL.textContent = `${countdown}s`;
        if (countdown <= 0) { clearInterval(countdownTimer); refresh(); }
      }, 1000);
    }

    async function refresh() {
      STATUS_MSG.textContent = 'Refreshing‚Ä¶';
      STATUS_MSG.style.display = 'block';
      try {
        const { matches, source } = await loadMatches();
        cachedMatches = matches;
        updateDateChips(matches);
        updateTournSelect(matches);
        renderAll(matches);
        setSourcePill(source);
        const isFallback = source === 'fallback';
        STATUS_MSG.textContent = isFallback ? 'Live feed unavailable ‚Äî showing sample data.' : 'Feed connected.';
        SUBTITLE.textContent   = isFallback ? 'Showing sample data' : `${source === 'python' ? 'Python backend' : 'ESPN direct'} ¬∑ auto-refresh 30s`;
        UPDATED_AT.textContent = `Updated ${new Date().toLocaleTimeString()}`;
        UPDATED_AT.style.display = 'block';
        if (!isFallback) setTimeout(() => { STATUS_MSG.style.display = 'none'; }, 2000);
        // Keep insights in sync if a match is still selected
        if (selectedId) {
          const m = cachedMatches.find(x => x.id === selectedId);
          if (m) showInsights(m);
        }
      } catch (err) {
        STATUS_MSG.textContent = `Error: ${err.message}`;
      }
      startCountdown();
    }

    // ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    tourChips.forEach(c => c.addEventListener('click', () => {
      tourFilter = c.dataset.tour;
      tournamentFilter = ''; // reset tournament filter when changing tour
      tourChips.forEach(x => x.classList.toggle('active', x === c));
      updateTournSelect(cachedMatches);
      renderAll(cachedMatches);
    }));

    TOURN_SEL.addEventListener('change', () => {
      tournamentFilter = TOURN_SEL.value;
      renderAll(cachedMatches);
    });

    BTN_LIVE.addEventListener('click', () => {
      liveOnly = !liveOnly;
      BTN_LIVE.classList.toggle('active', liveOnly);
      renderAll(cachedMatches);
    });

    refresh();
  </script>
</body>
</html>
